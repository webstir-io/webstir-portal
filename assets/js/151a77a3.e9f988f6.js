"use strict";(self.webpackChunkwebstir_portal=self.webpackChunkwebstir_portal||[]).push([[2261],{6684:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>d,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"product/plans/backend/module-contract-plan","title":"Module Contract Plan","description":"Goal","source":"@site/docs/product/plans/backend/module-contract-plan.md","sourceDirName":"product/plans/backend","slug":"/product/plans/backend/module-contract-plan","permalink":"/docs/product/plans/backend/module-contract-plan","draft":false,"unlisted":false,"editUrl":"https://github.com/webstir-io/webstir-portal/edit/main/docs/product/plans/backend/module-contract-plan.md","tags":[],"version":"current","lastUpdatedAt":1761688139000,"frontMatter":{},"sidebar":"plans","previous":{"title":"Backend Testing Tooling Plan","permalink":"/docs/product/plans/backend/backend-testing-tooling"},"next":{"title":"Webstir Backend Design","permalink":"/docs/product/plans/backend/webstir-backend-design"}}');var r=i(4848),t=i(8453);const o={},d="Module Contract Plan",c={},l=[];function a(e){const n={code:"code",h1:"h1",header:"header",li:"li",p:"p",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"module-contract-plan",children:"Module Contract Plan"})}),"\n",(0,r.jsx)(n.p,{children:"Goal"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Establish ",(0,r.jsx)(n.code,{children:"@webstir-io/module-contract"})," as the single authority for module/provider interfaces and runtime schemas (greenfield: no migration concerns)."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Scope & Principles"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Authority: ",(0,r.jsx)(n.code,{children:"module-contract/"})," defines the contract; provider repos implement it. Do not duplicate core interfaces elsewhere."]}),"\n",(0,r.jsx)(n.li,{children:"Separation of concerns: build-time provider API remains (ModuleProvider); runtime module surface (routes/views/jobs/events) lives alongside it in the same package."}),"\n",(0,r.jsx)(n.li,{children:"Minimal runtime deps: ship TypeScript types, Zod schemas, and generated JSON Schema; avoid adding heavy runtime dependencies to consumers."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Acceptance Criteria"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["TypeScript types for Contexts, RouteSpec, ViewSpec, ModuleManifest added under ",(0,r.jsx)(n.code,{children:"module-contract/src/"})," and compile."]}),"\n",(0,r.jsxs)(n.li,{children:["Zod schemas for these types exported, plus JSON Schema emitted to ",(0,r.jsx)(n.code,{children:"module-contract/schema/*"})," during build."]}),"\n",(0,r.jsxs)(n.li,{children:["Helper creators ",(0,r.jsx)(n.code,{children:"createModule"}),", ",(0,r.jsx)(n.code,{children:"defineRoute"}),", ",(0,r.jsx)(n.code,{children:"defineView"})," provide strong inference and pass compile-time tests."]}),"\n",(0,r.jsxs)(n.li,{children:["Example module (Accounts) compiles and validates using only ",(0,r.jsx)(n.code,{children:"module-contract"})," exports."]}),"\n",(0,r.jsxs)(n.li,{children:["No breaking changes to existing ",(0,r.jsx)(n.code,{children:"ModuleProvider"})," interfaces; README reflects new surfaces and build steps."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Validation & Errors"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Library: use Zod for runtime validation; publish Zod objects and JSON Schema (via build step) for non-TS consumers."}),"\n",(0,r.jsxs)(n.li,{children:["Error taxonomy: ",(0,r.jsx)(n.code,{children:"ValidationError"}),", ",(0,r.jsx)(n.code,{children:"AuthError"})," (unauthorized/forbidden), ",(0,r.jsx)(n.code,{children:"NotFoundError"}),", ",(0,r.jsx)(n.code,{children:"DomainError"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Error shape: ",(0,r.jsx)(n.code,{children:"{ code: string; message: string; details?: unknown; cause?: unknown; correlationId?: string }"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"Map to HTTP: 400 validation, 401/403 auth, 404 not found, 409 conflict (domain), 422 semantic; default 500."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Contexts & Provider Authority"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["RequestContext: ",(0,r.jsx)(n.code,{children:"{ req, res, auth, session, db, env, logger, requestId, now }"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["SSRContext (optional): ",(0,r.jsx)(n.code,{children:"{ url, params, cookies, headers, auth, session, env, logger }"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Provider interfaces (authoritative definitions live here):","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"BackendProvider: implements build + exposes route handlers bound to RequestContext."}),"\n",(0,r.jsx)(n.li,{children:"TestingProvider: emits testing events and manifest types."}),"\n",(0,r.jsxs)(n.li,{children:["AuthProvider: session primitives ",(0,r.jsx)(n.code,{children:"getSession"}),", ",(0,r.jsx)(n.code,{children:"createSession"}),", ",(0,r.jsx)(n.code,{children:"invalidateSession"}),", ",(0,r.jsx)(n.code,{children:"csrfToken"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["DatabaseProvider: generic ",(0,r.jsx)(n.code,{children:"db"})," handle with minimal query/tx abstraction; avoid binding to a specific ORM."]}),"\n",(0,r.jsx)(n.li,{children:"Optional: CacheProvider, QueueProvider (thin, capability flags in manifest)."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Logging: ",(0,r.jsx)(n.code,{children:"Logger"})," interface with levels, structured fields, ",(0,r.jsx)(n.code,{children:"with({})"}),", and correlation/request IDs."]}),"\n",(0,r.jsxs)(n.li,{children:["Config/Env: ",(0,r.jsx)(n.code,{children:"Env"})," accessor interface for typed retrieval and secret hints."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Manifest & Capabilities"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["ModuleManifest: ",(0,r.jsx)(n.code,{children:"{ name, version, kind: 'frontend'|'backend', routes?, views?, jobs?, events?, services?, init?, dispose?, capabilities?: string[], contractVersion: '1.x' }"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Capabilities: enumerate features (e.g., ",(0,r.jsx)(n.code,{children:"auth"}),", ",(0,r.jsx)(n.code,{children:"db"}),", ",(0,r.jsx)(n.code,{children:"queue"}),", ",(0,r.jsx)(n.code,{children:"cache"}),", ",(0,r.jsx)(n.code,{children:"views"}),") for orchestrator wiring."]}),"\n",(0,r.jsxs)(n.li,{children:["Versioning: single ",(0,r.jsx)(n.code,{children:"contractVersion"})," string; reserve feature flags per capability for evolution."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Routes & Views"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["RouteSpec: ",(0,r.jsx)(n.code,{children:"{ method, path, input: { params?, query?, body? }, output: { status, body }, handler(ctx) }"})," with Zod schemas for ",(0,r.jsx)(n.code,{children:"input/output"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["ViewSpec: ",(0,r.jsx)(n.code,{children:"{ path, params?, load(ctx) }"})," for SSR/loader-style data."]}),"\n",(0,r.jsxs)(n.li,{children:["ts-rest integration: provide an optional adapter ",(0,r.jsx)(n.code,{children:"fromTsRest(route)"})," and (later) typed client generation; ",(0,r.jsx)(n.code,{children:"ts-rest"})," remains an optional peer for providers, not a hard dep of the contract."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Discovery & Helpers"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Discovery: ",(0,r.jsx)(n.code,{children:"package.json"})," top-level ",(0,r.jsx)(n.code,{children:'"webstir.module"'})," object with ",(0,r.jsx)(n.code,{children:"{ kind, entry }"}),". Orchestrator discovers by this field and validates against JSON Schema."]}),"\n",(0,r.jsxs)(n.li,{children:["Helpers: ",(0,r.jsx)(n.code,{children:"createModule({ manifest, routes, views, ... })"}),", ",(0,r.jsx)(n.code,{children:"defineRoute({...})"}),", ",(0,r.jsx)(n.code,{children:"defineView({...})"})," with strong generics and Zod-powered inference."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Types, Examples & Tests"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Location: ",(0,r.jsx)(n.code,{children:"module-contract/src/"})," for types + Zod; JSON Schema emitted to ",(0,r.jsx)(n.code,{children:"module-contract/schema/"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Example: ",(0,r.jsx)(n.code,{children:"examples/accounts"})," (or colocated ",(0,r.jsx)(n.code,{children:"examples/"})," folder) defining 1\u20132 routes and one view using helpers."]}),"\n",(0,r.jsx)(n.li,{children:"Conventions doc additions: route naming, status codes, pagination/filter conventions, error codes."}),"\n",(0,r.jsxs)(n.li,{children:["Tests: unit tests for helper inference + runtime validation; compile-time checks using ",(0,r.jsx)(n.code,{children:"tsd"})," or ",(0,r.jsx)(n.code,{children:"expectTypeOf"}),"."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Non-Goals (for now)"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Cross-repo migration/rollout \u2014 not needed; no active consumers."}),"\n",(0,r.jsx)(n.li,{children:"Rich ORM/auth implementations \u2014 keep provider interfaces minimal and portable."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Implementation Notes"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Update ",(0,r.jsx)(n.code,{children:"module-contract/README.md"})," with new surfaces and build instructions."]}),"\n",(0,r.jsx)(n.li,{children:"Ensure build regenerates JSON Schema when Zod_types change; fail CI on drift."}),"\n",(0,r.jsxs)(n.li,{children:["Keep ",(0,r.jsx)(n.code,{children:"ModuleProvider"})," (build-time) unchanged to support orchestrator integration."]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>o,x:()=>d});var s=i(6540);const r={},t=s.createContext(r);function o(e){const n=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);