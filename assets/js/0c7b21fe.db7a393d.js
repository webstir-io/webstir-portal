"use strict";(self.webpackChunkwebstir_portal=self.webpackChunkwebstir_portal||[]).push([[7783],{768:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>i,contentTitle:()=>d,default:()=>h,frontMatter:()=>r,metadata:()=>t,toc:()=>o});const t=JSON.parse('{"id":"tutorials/backend-loop","title":"Backend Loop","description":"Build a backend-only flow that registers routes, touches the database helper, schedules a job, and inspects the manifest without starting the full dev server.","source":"@site/docs/tutorials/backend-loop.md","sourceDirName":"tutorials","slug":"/tutorials/backend-loop","permalink":"/docs/tutorials/backend-loop","draft":false,"unlisted":false,"editUrl":"https://github.com/webstir-io/webstir-portal/edit/main/docs/tutorials/backend-loop.md","tags":[],"version":"current","lastUpdatedAt":1762915999000,"frontMatter":{},"sidebar":"tutorials","previous":{"title":"Your First App","permalink":"/docs/tutorials/first-app"}}');var a=s(4848),c=s(8453);const r={},d="Backend Loop",i={},o=[{value:"1. Scaffold a workspace",id:"1-scaffold-a-workspace",level:2},{value:"2. Run backend-only watch",id:"2-run-backend-only-watch",level:2},{value:"3. Add a manifest-backed route",id:"3-add-a-manifest-backed-route",level:2},{value:"4. Connect to the database helper",id:"4-connect-to-the-database-helper",level:2},{value:"5. Schedule a job",id:"5-schedule-a-job",level:2},{value:"6. Inspect the manifest",id:"6-inspect-the-manifest",level:2},{value:"7. Publish backend assets only",id:"7-publish-backend-assets-only",level:2},{value:"Next",id:"next",level:2}];function l(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,c.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"backend-loop",children:"Backend Loop"})}),"\n",(0,a.jsx)(n.p,{children:"Build a backend-only flow that registers routes, touches the database helper, schedules a job, and inspects the manifest without starting the full dev server."}),"\n",(0,a.jsx)(n.h2,{id:"1-scaffold-a-workspace",children:"1. Scaffold a workspace"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"webstir init my-backend --server-only\ncd my-backend\ncp .env.example .env\n"})}),"\n",(0,a.jsxs)(n.blockquote,{children:["\n",(0,a.jsxs)(n.p,{children:["Tip: The server-only template still includes the frontend folders so the CLI can upgrade later. Passing ",(0,a.jsx)(n.code,{children:"--server-only"})," simply skips the initial frontend assets."]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"2-run-backend-only-watch",children:"2. Run backend-only watch"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"webstir watch --runtime backend\n"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["The CLI prints a scope summary such as ",(0,a.jsx)(n.code,{children:"filter: backend, running: backend-only"})," so you can confirm it is ignoring the UI workers."]}),"\n",(0,a.jsxs)(n.li,{children:["The Node server restarts whenever files under ",(0,a.jsx)(n.code,{children:"src/backend/**"})," change. Live reloads remain available for frontend edits if you drop the runtime flag."]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"3-add-a-manifest-backed-route",children:"3. Add a manifest-backed route"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'webstir add-route accounts \\\n  --method GET \\\n  --path /api/accounts \\\n  --summary "List accounts" \\\n  --description "Returns the signed-in user\'s accounts" \\\n  --tags accounts,api\n'})}),"\n",(0,a.jsxs)(n.p,{children:["Update ",(0,a.jsx)(n.code,{children:"src/backend/module.ts"})," with the handler. The scaffold already exports a ",(0,a.jsx)(n.code,{children:"module"})," object with ",(0,a.jsx)(n.code,{children:"routes"})," and ",(0,a.jsx)(n.code,{children:"jobs"}),"; extend it as shown:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ts",children:"import { createDatabaseClient } from './db/connection';\n\nconst routes = [\n  {\n    definition: {\n      name: 'listAccounts',\n      method: 'GET',\n      path: '/api/accounts',\n      summary: 'Return account metadata',\n      description: 'Demonstrates auth + db helpers'\n    },\n    handler: async (ctx: RouteContext) => {\n      if (!ctx.auth?.userId) {\n        return { status: 401, errors: [{ code: 'auth', message: 'Sign in required' }] };\n      }\n\n      const db = await createDatabaseClient();\n      const accounts = await db.query('select id, email from accounts where owner_id = ?', [ctx.auth.userId]);\n      await db.close();\n\n      return { status: 200, body: { accounts, greetedAt: ctx.now().toISOString() } };\n    }\n  }\n];\n\nexport const module = {\n  manifest: {\n    contractVersion: '1.0.0',\n    name: '@demo/backend',\n    version: '0.1.0',\n    kind: 'backend',\n    capabilities: ['http', 'auth', 'db'],\n    routes: routes.map((route) => route.definition)\n  },\n  routes\n};\n"})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"RouteContext"})," (already defined in the template) exposes ",(0,a.jsx)(n.code,{children:"params"}),", ",(0,a.jsx)(n.code,{children:"query"}),", ",(0,a.jsx)(n.code,{children:"body"}),", ",(0,a.jsx)(n.code,{children:"auth"}),", ",(0,a.jsx)(n.code,{children:"env"}),", ",(0,a.jsx)(n.code,{children:"logger"}),", ",(0,a.jsx)(n.code,{children:"requestId"}),", and ",(0,a.jsx)(n.code,{children:"now()"}),"."]}),"\n",(0,a.jsxs)(n.li,{children:["The backend provider loads ",(0,a.jsx)(n.code,{children:"build/backend/module.js"}),", logs the manifest summary, and automatically mounts every exported route\u2014no manual registration required."]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"4-connect-to-the-database-helper",children:"4. Connect to the database helper"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["The scaffold ships with ",(0,a.jsx)(n.code,{children:"src/backend/db/connection.ts"}),", which can create SQLite (",(0,a.jsx)(n.code,{children:"better-sqlite3"}),") or Postgres (",(0,a.jsx)(n.code,{children:"pg"}),") clients based on ",(0,a.jsx)(n.code,{children:"DATABASE_URL"}),"."]}),"\n",(0,a.jsxs)(n.li,{children:["Install the driver you plan to use, for example:","\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"npm install better-sqlite3\n"})}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["The helper ensures the SQLite directory exists and exposes simple ",(0,a.jsx)(n.code,{children:"query/execute/close"})," methods, making it ideal for cron-style jobs or lightweight APIs."]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"5-schedule-a-job",children:"5. Schedule a job"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:'webstir add-job nightly --schedule "0 0 * * *" --description "Nightly account sync" --priority 5\n'})}),"\n",(0,a.jsxs)(n.p,{children:["Implement the job in ",(0,a.jsx)(n.code,{children:"src/backend/jobs/nightly/index.ts"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ts",children:"import { createDatabaseClient } from '../../db/connection';\n\nexport async function run() {\n  const db = await createDatabaseClient();\n  await db.execute('update accounts set synced_at = datetime(\"now\")');\n  await db.close();\n  console.info('[nightly] accounts synced');\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"Test it quickly:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"node build/backend/jobs/scheduler.js --job nightly\n"})}),"\n",(0,a.jsx)(n.h2,{id:"6-inspect-the-manifest",children:"6. Inspect the manifest"}),"\n",(0,a.jsx)(n.p,{children:"You no longer need to start the dev service to verify capabilities/routes/jobs:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"webstir build --runtime backend\nwebstir backend-inspect\n"})}),"\n",(0,a.jsxs)(n.p,{children:["The inspect command prints the capabilities list plus every route and job recorded in ",(0,a.jsx)(n.code,{children:".webstir/backend-manifest.json"}),". This is the fastest way to double-check that metadata and schema references are wired correctly before pushing a branch."]}),"\n",(0,a.jsx)(n.h2,{id:"7-publish-backend-assets-only",children:"7. Publish backend assets only"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"webstir publish --runtime backend\n"})}),"\n",(0,a.jsxs)(n.p,{children:["This regenerates just the backend bundle and writes the manifest to ",(0,a.jsx)(n.code,{children:"dist/backend/**"}),", leaving the frontend artifacts untouched. Combine it with the Docker sandbox or your deployment scripts once you are ready."]}),"\n",(0,a.jsx)(n.h2,{id:"next",children:"Next"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["How-to: ",(0,a.jsx)(n.a,{href:"/docs/how-to/add-route",children:"Add a Backend Route"})]}),"\n",(0,a.jsxs)(n.li,{children:["How-to: ",(0,a.jsx)(n.a,{href:"/docs/how-to/add-job",children:"Add a Backend Job"})]}),"\n",(0,a.jsxs)(n.li,{children:["Reference: ",(0,a.jsx)(n.a,{href:"/docs/reference/cli",children:"CLI"})]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(l,{...e})}):l(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>r,x:()=>d});var t=s(6540);const a={},c=t.createContext(a);function r(e){const n=t.useContext(c);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),t.createElement(c.Provider,{value:n},e.children)}}}]);