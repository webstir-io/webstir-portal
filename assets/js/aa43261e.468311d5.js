"use strict";(self.webpackChunkwebstir_portal=self.webpackChunkwebstir_portal||[]).push([[3072],{365:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>t,default:()=>h,frontMatter:()=>d,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"explanations/engine","title":"Engine","description":"Core implementation that powers the CLI. The engine owns workflows, pipelines, servers, watching, and the project workspace. This doc expands the high-level overview in solution.md.","source":"@site/docs/explanations/engine.md","sourceDirName":"explanations","slug":"/explanations/engine","permalink":"/docs/explanations/engine","draft":false,"unlisted":false,"editUrl":"https://github.com/webstir-io/webstir-portal/edit/main/docs/explanations/engine.md","tags":[],"version":"current","lastUpdatedAt":1764454564000,"frontMatter":{},"sidebar":"explanations","previous":{"title":"Dev Service","permalink":"/docs/explanations/devservice"},"next":{"title":"Pipelines","permalink":"/docs/explanations/pipelines"}}');var r=s(4848),l=s(8453);const d={},t="Engine",o={},c=[{value:"Overview",id:"overview",level:2},{value:"Responsibilities",id:"responsibilities",level:2},{value:"Structure",id:"structure",level:2},{value:"Workflows",id:"workflows",level:2},{value:"Workers",id:"workers",level:2},{value:"Pipelines",id:"pipelines",level:2},{value:"Services",id:"services",level:2},{value:"Servers",id:"servers",level:2},{value:"Change Detection",id:"change-detection",level:2},{value:"Outputs",id:"outputs",level:2},{value:"Errors &amp; Logging",id:"errors--logging",level:2},{value:"Client Error Reporting",id:"client-error-reporting",level:2},{value:"Extensibility",id:"extensibility",level:2},{value:"Testing",id:"testing",level:2},{value:"Contracts (Key Invariants)",id:"contracts-key-invariants",level:2},{value:"Related Docs",id:"related-docs",level:2}];function a(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",strong:"strong",ul:"ul",...(0,l.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"engine",children:"Engine"})}),"\n",(0,r.jsxs)(n.p,{children:["Core implementation that powers the CLI. The engine owns workflows, pipelines, servers, watching, and the project workspace. This doc expands the high-level overview in ",(0,r.jsx)(n.a,{href:"/docs/explanations/solution",children:"solution.md"}),"."]}),"\n",(0,r.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Orchestrates end-to-end workflows: init \u2192 build \u2192 watch/test \u2192 publish."}),"\n",(0,r.jsx)(n.li,{children:"Implements HTML/CSS/TS and static asset pipelines (Images, Fonts, Media), plus dev servers."}),"\n",(0,r.jsxs)(n.li,{children:["Uses a strongly typed workspace (",(0,r.jsx)(n.code,{children:"AppWorkspace"}),") for all paths."]}),"\n",(0,r.jsx)(n.li,{children:"Keeps defaults simple; favors conventions over configuration."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"responsibilities",children:"Responsibilities"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Parse and validate input workspace (folders, files, options)."}),"\n",(0,r.jsx)(n.li,{children:"Run pipelines for frontend, backend, and shared code."}),"\n",(0,r.jsxs)(n.li,{children:["Serve ",(0,r.jsx)(n.code,{children:"build/"})," in dev; proxy ",(0,r.jsx)(n.code,{children:"/api/*"})," to the Node server."]}),"\n",(0,r.jsxs)(n.li,{children:["Watch ",(0,r.jsx)(n.code,{children:"src/**"}),", perform incremental rebuilds, and reload browsers via SSE."]}),"\n",(0,r.jsxs)(n.li,{children:["Optimize and emit production assets in ",(0,r.jsx)(n.code,{children:"dist/"})," with manifests."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"structure",children:"Structure"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Workflows \u2014 high-level orchestration: ",(0,r.jsx)(n.a,{href:"/docs/reference/workflows",children:"workflows"})]}),"\n",(0,r.jsxs)(n.li,{children:["Pipelines \u2014 HTML, CSS, JS/TS stages: ",(0,r.jsx)(n.a,{href:"/docs/explanations/pipelines",children:"pipelines"})]}),"\n",(0,r.jsxs)(n.li,{children:["Services \u2014 dev, watch, change coordination: ",(0,r.jsx)(n.a,{href:"/docs/explanations/devservice",children:"dev service"})]}),"\n",(0,r.jsx)(n.li,{children:"Workers \u2014 per-area units (frontend/backend/shared)"}),"\n",(0,r.jsx)(n.li,{children:"Servers \u2014 dev static server (ASP.NET Core) + Node API host"}),"\n",(0,r.jsxs)(n.li,{children:["Templates \u2014 embedded project scaffolding: ",(0,r.jsx)(n.a,{href:"/docs/reference/templates",children:"templates"})]}),"\n",(0,r.jsxs)(n.li,{children:["Workspace \u2014 paths and constants: ",(0,r.jsx)(n.a,{href:"/docs/explanations/workspace",children:"workspace"})]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"workflows",children:"Workflows"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"init: Create a project from templates (frontend, backend, shared, types). Writes a ready-to-run structure."}),"\n",(0,r.jsxs)(n.li,{children:["build: Compile TS, process CSS, merge page HTML with ",(0,r.jsx)(n.code,{children:"app.html"}),", emit to ",(0,r.jsx)(n.code,{children:"build/"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"watch: Run build and tests, start servers, then react to changes with targeted rebuilds and reloads."}),"\n",(0,r.jsx)(n.li,{children:"test: Build, execute compiled tests in Node, return CI-friendly exit codes."}),"\n",(0,r.jsxs)(n.li,{children:["publish: Optimize and fingerprint assets into ",(0,r.jsx)(n.code,{children:"dist/"})," and rewrite HTML with per-page manifests."]}),"\n",(0,r.jsxs)(n.li,{children:["generators: ",(0,r.jsx)(n.code,{children:"add-page"}),", ",(0,r.jsx)(n.code,{children:"add-test"})," create files in the right locations."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Workflows call workers and services; they should not contain low-level file logic."}),"\n",(0,r.jsx)(n.h2,{id:"workers",children:"Workers"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["FrontendWorker: Shells out to the ",(0,r.jsx)(n.code,{children:"@webstir-io/webstir-frontend"})," TypeScript CLI for build/publish/add-page while enforcing package pinning."]}),"\n",(0,r.jsxs)(n.li,{children:["BackendWorker: Compiles backend TS \u2192 ",(0,r.jsx)(n.code,{children:"build/backend/"}),", tracks restart state."]}),"\n",(0,r.jsx)(n.li,{children:"SharedWorker: Ensures shared types are compiled and available to both sides."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Contracts and DI"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["IWorkflowWorker: Common contract used by all workers (",(0,r.jsx)(n.code,{children:"BuildOrder"}),", ",(0,r.jsx)(n.code,{children:"InitAsync"}),", ",(0,r.jsx)(n.code,{children:"BuildAsync"}),", ",(0,r.jsx)(n.code,{children:"PublishAsync"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:["IFrontendWorker: Extends ",(0,r.jsx)(n.code,{children:"IWorkflowWorker"})," with ",(0,r.jsx)(n.code,{children:"AddPageAsync"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["DI registers all workers as ",(0,r.jsx)(n.code,{children:"IWorkflowWorker"}),"; workflows inject ",(0,r.jsx)(n.code,{children:"IEnumerable<IWorkflowWorker>"})," and filter by project mode."]}),"\n",(0,r.jsxs)(n.li,{children:["Generators (e.g., add-page) resolve the single ",(0,r.jsx)(n.code,{children:"IFrontendWorker"})," and it relays to the TypeScript CLI, keeping scaffolds in sync with framework templates."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Workers are incremental where possible: only touched pages or modules are reprocessed."}),"\n",(0,r.jsx)(n.h2,{id:"pipelines",children:"Pipelines"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["HTML: Merge page fragments into ",(0,r.jsx)(n.code,{children:"src/frontend/app/app.html"})," (requires a ",(0,r.jsx)(n.code,{children:"<main>"}),"), validate, write to ",(0,r.jsx)(n.code,{children:"build/frontend/pages/<page>/index.html"}),". In publish, minify and rewrite links from the manifest."]}),"\n",(0,r.jsxs)(n.li,{children:["CSS: ",(0,r.jsx)(n.strong,{children:"esbuild"})," handles CSS bundling alongside JavaScript for a unified pipeline. Resolves ",(0,r.jsx)(n.code,{children:"@import"}),", processes CSS Modules, rewrites URLs. In publish, minifies and fingerprints output."]}),"\n",(0,r.jsxs)(n.li,{children:["JS/TS: Use ",(0,r.jsx)(n.code,{children:"tsc --build"})," for type checking, then ",(0,r.jsx)(n.strong,{children:"esbuild"})," for bundling (10-100x faster). ESM format; tree-shake/minify in publish."]}),"\n",(0,r.jsxs)(n.li,{children:["Assets: Copy Images, Fonts, and Media from ",(0,r.jsx)(n.code,{children:"src/frontend/**"})," \u2192 ",(0,r.jsx)(n.code,{children:"build/frontend/**"})," (dev). In publish, optimize (compress images, convert fonts to WOFF2) when tools available, then copy to ",(0,r.jsx)(n.code,{children:"dist/frontend/**"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["See details in ",(0,r.jsx)(n.a,{href:"/docs/explanations/pipelines",children:"pipelines"}),"."]}),"\n",(0,r.jsx)(n.h2,{id:"services",children:"Services"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["DevService: Hosts the dev web server that serves ",(0,r.jsx)(n.code,{children:"build/frontend/**"}),", exposes an SSE endpoint for reloads, and proxies ",(0,r.jsx)(n.code,{children:"/api/*"})," to the Node server."]}),"\n",(0,r.jsxs)(n.li,{children:["WatchService: Manages file watching over ",(0,r.jsx)(n.code,{children:"src/**"}),", batching events to avoid thrash."]}),"\n",(0,r.jsx)(n.li,{children:"ChangeService: Classifies changes (frontend/backend/shared), deduplicates, and schedules the minimal work."}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["See ",(0,r.jsx)(n.a,{href:"/docs/explanations/devservice",children:"dev service"})," for behavior and lifecycle."]}),"\n",(0,r.jsx)(n.h2,{id:"servers",children:"Servers"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Web server: ASP.NET Core minimal app serving ",(0,r.jsx)(n.code,{children:"build/frontend/**"}),", clean URLs, dev cache headers, SSE for reload."]}),"\n",(0,r.jsxs)(n.li,{children:["Node server: Runs ",(0,r.jsx)(n.code,{children:"build/backend/index.js"}),". Restarts on backend code changes. Dev server proxies ",(0,r.jsx)(n.code,{children:"/api/*"})," to this process."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"change-detection",children:"Change Detection"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"FileSystemWatcher feeds a buffered queue to coalesce rapid changes."}),"\n",(0,r.jsxs)(n.li,{children:["Routing rules:","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Frontend changes \u2192 frontend pipelines \u2192 write to ",(0,r.jsx)(n.code,{children:"build/frontend/**"})," \u2192 broadcast SSE reload."]}),"\n",(0,r.jsx)(n.li,{children:"Backend changes \u2192 backend compile \u2192 restart Node process."}),"\n",(0,r.jsx)(n.li,{children:"Shared changes \u2192 rebuild affected frontend and backend targets."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"outputs",children:"Outputs"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Dev: ",(0,r.jsx)(n.code,{children:"build/frontend/**"})," and ",(0,r.jsx)(n.code,{children:"build/backend/**"}),", readable output with source context."]}),"\n",(0,r.jsxs)(n.li,{children:["Prod: ",(0,r.jsx)(n.code,{children:"dist/frontend/pages/<page>/index.<hash>.{css|js}"}),", HTML rewritten to fingerprinted assets, per-page ",(0,r.jsx)(n.code,{children:"manifest.json"}),"."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"errors--logging",children:"Errors & Logging"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Use clear, actionable errors; do not swallow exceptions silently."}),"\n",(0,r.jsx)(n.li,{children:"Surface build/test failures with non-zero exit codes to the CLI."}),"\n",(0,r.jsx)(n.li,{children:"Prefer structured logs that highlight the failing stage and file."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"client-error-reporting",children:"Client Error Reporting"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Client handler: template includes ",(0,r.jsx)(n.code,{children:"/app/error.js"}),", which installs ",(0,r.jsx)(n.code,{children:"window.__WEBSTIR_ON_ERROR__"})," and listens for ",(0,r.jsx)(n.code,{children:"error"})," and ",(0,r.jsx)(n.code,{children:"unhandledrejection"})," events."]}),"\n",(0,r.jsxs)(n.li,{children:["Endpoint: the web server exposes ",(0,r.jsx)(n.code,{children:"POST /client-errors"}),". Payload must be ",(0,r.jsx)(n.code,{children:"application/json"})," and ",(0,r.jsx)(n.code,{children:"<= 32KB"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Limits: server returns ",(0,r.jsx)(n.code,{children:"415"})," for non-JSON and ",(0,r.jsx)(n.code,{children:"413"})," for oversized payloads; ",(0,r.jsx)(n.code,{children:"204"})," on success."]}),"\n",(0,r.jsxs)(n.li,{children:["Correlation: handler includes a client-generated correlation id; server also reads ",(0,r.jsx)(n.code,{children:"X-Correlation-ID"})," when present and forwards all reports to ",(0,r.jsx)(n.code,{children:"ErrorTrackingService"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"Guardrails: client deduplicates repeats within 60s and throttles to 1 event/second with a 20-report cap per page session."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"extensibility",children:"Extensibility"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"No plugin system. Extend by adding pipeline stages or worker capabilities."}),"\n",(0,r.jsx)(n.li,{children:"Keep changes local and behavior-preserving; prefer mechanical, minimal diffs."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"testing",children:"Testing"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Favor end-to-end workflow tests over unit tests. See ",(0,r.jsx)(n.a,{href:"/docs/explanations/testing",children:"tests"})," and the ",(0,r.jsx)(n.a,{href:"https://github.com/webstir-io/webstir-dotnet/blob/main/.codex/testing.md",children:"orchestrator testing guide"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"Lock down contracts: commands, flags, exit codes, directory structure, and publish outputs."}),"\n",(0,r.jsx)(n.li,{children:"Use snapshot tests for scaffolding and publish artifacts where practical."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"contracts-key-invariants",children:"Contracts (Key Invariants)"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Source roots: ",(0,r.jsx)(n.code,{children:"src/frontend/**"}),", ",(0,r.jsx)(n.code,{children:"src/backend/**"}),", ",(0,r.jsx)(n.code,{children:"src/shared/**"}),", ",(0,r.jsx)(n.code,{children:"types/**"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Dev outputs: ",(0,r.jsx)(n.code,{children:"build/frontend/**"}),", ",(0,r.jsx)(n.code,{children:"build/backend/**"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Prod outputs: ",(0,r.jsx)(n.code,{children:"dist/frontend/pages/<page>/**"})," with per-page manifests."]}),"\n",(0,r.jsxs)(n.li,{children:["API proxy: HTTP requests under ",(0,r.jsx)(n.code,{children:"/api/*"})," route to the Node server in dev."]}),"\n",(0,r.jsxs)(n.li,{children:["Base HTML requires ",(0,r.jsx)(n.code,{children:"<main>"})," in ",(0,r.jsx)(n.code,{children:"src/frontend/app/app.html"}),"."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"related-docs",children:"Related Docs"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Solution overview \u2014 ",(0,r.jsx)(n.a,{href:"/docs/explanations/solution",children:"solution"})]}),"\n",(0,r.jsxs)(n.li,{children:["CLI reference \u2014 ",(0,r.jsx)(n.a,{href:"/docs/reference/cli",children:"cli"})]}),"\n",(0,r.jsxs)(n.li,{children:["Pipelines \u2014 ",(0,r.jsx)(n.a,{href:"/docs/explanations/pipelines",children:"pipelines"})]}),"\n",(0,r.jsxs)(n.li,{children:["Dev service \u2014 ",(0,r.jsx)(n.a,{href:"/docs/explanations/devservice",children:"devservice"})]}),"\n",(0,r.jsxs)(n.li,{children:["Workflows \u2014 ",(0,r.jsx)(n.a,{href:"/docs/reference/workflows",children:"workflows"})]}),"\n",(0,r.jsxs)(n.li,{children:["Workspace and paths \u2014 ",(0,r.jsx)(n.a,{href:"/docs/explanations/workspace",children:"workspace"})]}),"\n",(0,r.jsxs)(n.li,{children:["Templates \u2014 ",(0,r.jsx)(n.a,{href:"/docs/reference/templates",children:"templates"})]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>d,x:()=>t});var i=s(6540);const r={},l=i.createContext(r);function d(e){const n=i.useContext(l);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:d(e.components),i.createElement(l.Provider,{value:n},e.children)}}}]);