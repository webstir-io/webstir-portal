"use strict";(self.webpackChunkwebstir_portal=self.webpackChunkwebstir_portal||[]).push([[3552],{8453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>l});var i=s(6540);const d={},t=i.createContext(d);function o(e){const n=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(d):e.components||d:o(e.components),i.createElement(t.Provider,{value:n},e.children)}},9213:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>o,metadata:()=>i,toc:()=>r});const i=JSON.parse('{"id":"how-to/add-job","title":"Add a Backend Job","description":"Scaffold a job stub and record it in the module manifest.","source":"@site/docs/how-to/add-job.md","sourceDirName":"how-to","slug":"/how-to/add-job","permalink":"/docs/how-to/add-job","draft":false,"unlisted":false,"editUrl":"https://github.com/webstir-io/webstir-portal/edit/main/docs/how-to/add-job.md","tags":[],"version":"current","lastUpdatedAt":1762915999000,"frontMatter":{},"sidebar":"howTo","previous":{"title":"How-to Guides","permalink":"/docs/how-to/"},"next":{"title":"Add Page","permalink":"/docs/how-to/add-page"}}');var d=s(4848),t=s(8453);const o={},l="Add a Backend Job",c={},r=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Steps",id:"steps",level:2},{value:"Implement the job",id:"implement-the-job",level:2},{value:"Notes",id:"notes",level:2},{value:"See Also",id:"see-also",level:2}];function a(e){const n={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,t.R)(),...e.components};return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(n.header,{children:(0,d.jsx)(n.h1,{id:"add-a-backend-job",children:"Add a Backend Job"})}),"\n",(0,d.jsx)(n.p,{children:"Scaffold a job stub and record it in the module manifest."}),"\n",(0,d.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsxs)(n.li,{children:["A Webstir workspace initialized via ",(0,d.jsx)(n.code,{children:"webstir init ..."}),"."]}),"\n",(0,d.jsxs)(n.li,{children:["Backend source at ",(0,d.jsx)(n.code,{children:"src/backend/"}),"."]}),"\n"]}),"\n",(0,d.jsx)(n.h2,{id:"steps",children:"Steps"}),"\n",(0,d.jsxs)(n.ol,{children:["\n",(0,d.jsxs)(n.li,{children:["Create a job named ",(0,d.jsx)(n.code,{children:"cleanup"}),":","\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsx)(n.li,{children:(0,d.jsx)(n.code,{children:"webstir add-job cleanup"})}),"\n",(0,d.jsxs)(n.li,{children:["Creates ",(0,d.jsx)(n.code,{children:"src/backend/jobs/cleanup/index.ts"})," with a ",(0,d.jsx)(n.code,{children:"run()"})," function."]}),"\n",(0,d.jsxs)(n.li,{children:["Adds ",(0,d.jsx)(n.code,{children:'{ name: "cleanup" }'})," to ",(0,d.jsx)(n.code,{children:"webstir.module.jobs"})," in ",(0,d.jsx)(n.code,{children:"package.json"}),"."]}),"\n"]}),"\n"]}),"\n",(0,d.jsxs)(n.li,{children:["Add metadata as needed:","\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsxs)(n.li,{children:["Schedule: ",(0,d.jsx)(n.code,{children:'webstir add-job nightly --schedule "0 0 * * *"'})]}),"\n",(0,d.jsxs)(n.li,{children:["Description: ",(0,d.jsx)(n.code,{children:'--description "Nightly maintenance window"'})]}),"\n",(0,d.jsxs)(n.li,{children:["Priority: ",(0,d.jsx)(n.code,{children:"--priority 5"})," (accepts numbers or free-form labels)"]}),"\n"]}),"\n"]}),"\n",(0,d.jsxs)(n.li,{children:["Iterate on the job implementation (see below) and rebuild/watch with ",(0,d.jsx)(n.code,{children:"--runtime backend"}),"."]}),"\n",(0,d.jsxs)(n.li,{children:["Run jobs locally:","\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsxs)(n.li,{children:["List metadata: ",(0,d.jsx)(n.code,{children:"node build/backend/jobs/scheduler.js --list"})]}),"\n",(0,d.jsxs)(n.li,{children:["Run once: ",(0,d.jsx)(n.code,{children:"node build/backend/jobs/scheduler.js --job nightly"})]}),"\n",(0,d.jsxs)(n.li,{children:["Simple watcher: ",(0,d.jsx)(n.code,{children:"node build/backend/jobs/scheduler.js --watch"})]}),"\n",(0,d.jsxs)(n.li,{children:["Direct execution: ",(0,d.jsx)(n.code,{children:"node build/backend/jobs/<name>/index.js"})]}),"\n"]}),"\n"]}),"\n",(0,d.jsxs)(n.li,{children:["Inspect the manifest to confirm the job metadata:","\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsx)(n.li,{children:(0,d.jsx)(n.code,{children:"webstir backend-inspect"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,d.jsx)(n.h2,{id:"implement-the-job",children:"Implement the job"}),"\n",(0,d.jsxs)(n.p,{children:["Jobs receive the same environment access and logging helpers as HTTP handlers. The scaffold exports a ",(0,d.jsx)(n.code,{children:"run()"})," function you can extend:"]}),"\n",(0,d.jsx)(n.pre,{children:(0,d.jsx)(n.code,{className:"language-ts",children:"// src/backend/jobs/cleanup/index.ts\nimport { createDatabaseClient } from '../../db/connection';\n\nexport async function run() {\n  const db = await createDatabaseClient();\n  const stale = await db.query('select id from sessions where expires_at < datetime(\"now\")');\n\n  if (stale.length > 0) {\n    await db.execute('delete from sessions where id in (?)', [stale.map((row) => row.id)]);\n    console.info('[jobs] cleaned sessions', { count: stale.length });\n  } else {\n    console.info('[jobs] no sessions to clean');\n  }\n\n  await db.close();\n}\n"})}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsxs)(n.li,{children:[(0,d.jsx)(n.code,{children:".env"})," values are loaded automatically; use ",(0,d.jsx)(n.code,{children:"process.env.NAME"})," or the helper exported from the template."]}),"\n",(0,d.jsx)(n.li,{children:"The scheduler prints job names, schedules, and manifest metadata so you can verify exactly what will run in CI or production."}),"\n"]}),"\n",(0,d.jsx)(n.h2,{id:"notes",children:"Notes"}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsxs)(n.li,{children:["The CLI validates ",(0,d.jsx)(n.code,{children:"--schedule"})," strings (",(0,d.jsx)(n.code,{children:"@hourly"}),", ",(0,d.jsx)(n.code,{children:"@daily"}),", or cron-style fields) but stores them exactly as provided so your production scheduler can interpret them."]}),"\n",(0,d.jsxs)(n.li,{children:["The built-in watcher understands ",(0,d.jsx)(n.code,{children:"@hourly"}),", ",(0,d.jsx)(n.code,{children:"@daily"}),", ",(0,d.jsx)(n.code,{children:"@weekly"}),", ",(0,d.jsx)(n.code,{children:"@reboot"}),", and ",(0,d.jsx)(n.code,{children:"rate(n unit)"})," syntax. Cron expressions are surfaced in the manifest so you can wire them into Temporal, Cloud Scheduler, etc."]}),"\n",(0,d.jsxs)(n.li,{children:["Jobs run through the scheduler automatically load ",(0,d.jsx)(n.code,{children:".env"})," values, reuse the backend logger, and emit structured logs just like HTTP handlers."]}),"\n",(0,d.jsxs)(n.li,{children:["Use ",(0,d.jsx)(n.code,{children:"webstir backend-inspect"})," after adding jobs to confirm the manifest entry (name, schedule, description, priority) before committing changes."]}),"\n"]}),"\n",(0,d.jsx)(n.h2,{id:"see-also",children:"See Also"}),"\n",(0,d.jsxs)(n.ul,{children:["\n",(0,d.jsxs)(n.li,{children:["CLI reference: ",(0,d.jsx)(n.code,{children:"../reference/cli.md#add-job"})]}),"\n",(0,d.jsxs)(n.li,{children:["Backend provider: ",(0,d.jsx)(n.code,{children:"../explanations/solution.md"})," (manifest ingestion)"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,d.jsx)(n,{...e,children:(0,d.jsx)(a,{...e})}):a(e)}}}]);