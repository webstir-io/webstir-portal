"use strict";(self.webpackChunkwebstir_portal=self.webpackChunkwebstir_portal||[]).push([[1123],{8453:(e,s,n)=>{n.d(s,{R:()=>d,x:()=>c});var t=n(6540);const i={},r=t.createContext(i);function d(e){const s=t.useContext(r);return t.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:d(e.components),t.createElement(r.Provider,{value:s},e.children)}},9998:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>o,contentTitle:()=>c,default:()=>h,frontMatter:()=>d,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"product/plans/backend/backend-testing-tooling","title":"Backend Testing Tooling Plan","description":"Goal","source":"@site/docs/product/plans/backend/backend-testing-tooling.md","sourceDirName":"product/plans/backend","slug":"/product/plans/backend/backend-testing-tooling","permalink":"/docs/product/plans/backend/backend-testing-tooling","draft":false,"unlisted":false,"editUrl":"https://github.com/webstir-io/webstir-portal/edit/main/docs/product/plans/backend/backend-testing-tooling.md","tags":[],"version":"current","lastUpdatedAt":1762835338000,"frontMatter":{},"sidebar":"plans","previous":{"title":"Product Plans","permalink":"/docs/product/plans"},"next":{"title":"Module Contract Plan","permalink":"/docs/product/plans/backend/module-contract-plan"}}');var i=n(4848),r=n(8453);const d={},c="Backend Testing Tooling Plan",o={},l=[{value:"Goal",id:"goal",level:2},{value:"Current State",id:"current-state",level:2},{value:"In Scope",id:"in-scope",level:2},{value:"Out of Scope",id:"out-of-scope",level:2},{value:"Functional Requirements",id:"functional-requirements",level:2},{value:"Non-Functional Requirements",id:"non-functional-requirements",level:2},{value:"Proposed Architecture",id:"proposed-architecture",level:2},{value:"1. CLI &amp; Workflow updates (C#)",id:"1-cli--workflow-updates-c",level:3},{value:"2. Node-side harness (<code>@webstir-io/webstir-backend/testing</code>)",id:"2-node-side-harness-webstir-iowebstir-backendtesting",level:3},{value:"3. Testing provider integration (<code>@webstir-io/webstir-testing</code>)",id:"3-testing-provider-integration-webstir-iowebstir-testing",level:3},{value:"4. Dev server plumbing",id:"4-dev-server-plumbing",level:3},{value:"Validation Strategy",id:"validation-strategy",level:2},{value:"Rollout / Steps",id:"rollout--steps",level:2},{value:"Open Questions",id:"open-questions",level:2}];function a(e){const s={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(s.header,{children:(0,i.jsx)(s.h1,{id:"backend-testing-tooling-plan",children:"Backend Testing Tooling Plan"})}),"\n",(0,i.jsx)(s.h2,{id:"goal",children:"Goal"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Give backend module authors a first-class way to run route + contract tests from the CLI, including request helpers that understand the module manifest emitted by ",(0,i.jsx)(s.code,{children:"@webstir-io/webstir-backend"}),"."]}),"\n",(0,i.jsx)(s.li,{children:"Provide a standardized harness that can spin up the compiled backend server (default scaffold or Fastify) for integration tests and dev loops without manual scripts."}),"\n",(0,i.jsxs)(s.li,{children:["Fit into the existing ",(0,i.jsx)(s.code,{children:"webstir test"})," / ",(0,i.jsx)(s.code,{children:"webstir watch"})," workflows so backend coverage runs automatically in CI and during ",(0,i.jsx)(s.code,{children:"webstir watch"}),"."]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"current-state",children:"Current State"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"webstir test"})," compiles TypeScript, builds the backend via ",(0,i.jsx)(s.code,{children:"ModuleBuildExecutor"}),", then shells out to ",(0,i.jsx)(s.code,{children:"webstir-testing"})," (",(0,i.jsx)(s.code,{children:"webstir-dotnet/Engine/Workflows/TestWorkflow.cs:21-60"}),"). The runner simply executes compiled ",(0,i.jsx)(s.code,{children:".test.js"})," files inside a Node VM (",(0,i.jsx)(s.code,{children:"webstir-testing/src/runtime.ts"}),"), so backend tests cannot hit a real server or share bootstrapped context."]}),"\n",(0,i.jsxs)(s.li,{children:["The manifest metadata and route definitions exposed by ",(0,i.jsx)(s.code,{children:"backendProvider"})," (",(0,i.jsx)(s.code,{children:"webstir-backend/src/provider.ts"}),") are only logged in dev/watch (",(0,i.jsx)(s.code,{children:"webstir-dotnet/Engine/Services/DevService.cs:24-121"}),"). There is no automated harness to assert that handlers satisfy their contract or that exported routes respond correctly."]}),"\n",(0,i.jsxs)(s.li,{children:["Developers that need integration coverage must manually start ",(0,i.jsx)(s.code,{children:"node build/backend/index.js"})," (or Fastify) in one terminal and run ad-hoc scripts in another, which does not exercise orchestrator plumbing, env toggles, or module events."]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"in-scope",children:"In Scope"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Extend the CLI surface so backend-only tests can be invoked directly (headless) or alongside ",(0,i.jsx)(s.code,{children:"webstir watch"}),"."]}),"\n",(0,i.jsx)(s.li,{children:"Introduce a backend-aware testing provider that can start the compiled server, expose HTTP helpers, and hydrate route metadata/contracts for assertions."}),"\n",(0,i.jsxs)(s.li,{children:["Wire readiness + teardown into ",(0,i.jsx)(s.code,{children:"ProcessHandle"})," so test workflows can block on a healthy ",(0,i.jsx)(s.code,{children:"/api/health"})," without bespoke scripts."]}),"\n",(0,i.jsxs)(s.li,{children:["Document the harness (APIs, env vars, defaults) inside ",(0,i.jsx)(s.code,{children:"webstir-portal"})," and surface the workflow under the \u201cBackend Design\u201d plan."]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"out-of-scope",children:"Out of Scope"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Shipping new backend server scaffolds (Fastify already exists under ",(0,i.jsx)(s.code,{children:"templates/backend/server/fastify.ts"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:["Replacing the existing ",(0,i.jsx)(s.code,{children:"webstir-testing"})," manifest discovery logic."]}),"\n",(0,i.jsx)(s.li,{children:"Full E2E orchestration across frontend + backend + database (follow-up once backend harness lands)."}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"functional-requirements",children:"Functional Requirements"}),"\n",(0,i.jsxs)(s.ol,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"CLI entry points"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"webstir backend test [--watch] [--filter <glob>] [--dev-server <embedded|external>]"})," routes to a dedicated workflow so backend modules do not need to scan frontend specs."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"webstir backend dev [--tests] [--port <number>]"})," starts the backend watch pipeline (",(0,i.jsx)(s.code,{children:"startBackendWatch"})," from ",(0,i.jsx)(s.code,{children:"@webstir-io/webstir-backend/src/watch.ts"}),") and optionally triggers backend tests on rebuild."]}),"\n",(0,i.jsxs)(s.li,{children:["Existing ",(0,i.jsx)(s.code,{children:"webstir test"})," / ",(0,i.jsx)(s.code,{children:"webstir watch"})," commands should delegate to the backend harness when backend tests are present so CI does not need a new entry point."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Harness behavior"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Each backend test run must build the backend in ",(0,i.jsx)(s.code,{children:"ModuleBuildMode.Test"})," and capture manifest routes before starting tests."]}),"\n",(0,i.jsxs)(s.li,{children:["The harness should start the compiled backend entry (",(0,i.jsx)(s.code,{children:"build/backend/index.js"})," or Fastify) once, wait for the readiness log (",(0,i.jsx)(s.code,{children:"API server running"}),"), expose the port + base URL to tests, then reuse the process across files unless a test requests isolation."]}),"\n",(0,i.jsxs)(s.li,{children:["Provide a TypeScript helper (e.g., ",(0,i.jsx)(s.code,{children:"import { backendTest } from '@webstir-io/webstir-backend/testing'"}),") that wraps the generic ",(0,i.jsx)(s.code,{children:"test()"})," API, injects a supertest-like ",(0,i.jsx)(s.code,{children:"request()"})," helper, and preloads module routes + schema metadata."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Contract assertions"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Helpers should be able to load the hydrated module manifest (routes, schemas) returned from the provider to ensure tests can compare responses against the declared contract (status codes, schema refs)."}),"\n",(0,i.jsxs)(s.li,{children:["Failures should emit ",(0,i.jsx)(s.code,{children:"WEBSTIR_MODULE_EVENT"})," lines so orchestrator logs mirror the existing test runner output."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Dev server for integration"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"webstir backend dev --tests"})," should combine the esbuild watch (",(0,i.jsx)(s.code,{children:"startBackendWatch"}),") with the new harness: rebuild on change, restart the backend server, rerun backend specs, surface hot output via the Dev Service console."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"non-functional-requirements",children:"Non-Functional Requirements"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Runs must work in air-gapped CI (no npm install during test time). All helpers must live in first-party packages (",(0,i.jsx)(s.code,{children:"@webstir-io/webstir-backend"}),", ",(0,i.jsx)(s.code,{children:"@webstir-io/webstir-testing"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:["Server startup/teardown must respect the shared ",(0,i.jsx)(s.code,{children:"ProcessHandle"})," timeout + cancellation semantics (",(0,i.jsx)(s.code,{children:"webstir-dotnet/Utilities/ProcessRunner/ProcessHandle.cs"}),"), so hung tests do not wedge the CLI."]}),"\n",(0,i.jsxs)(s.li,{children:["The harness cannot assume a specific framework. It should treat the compiled backend entry as a black box that emits readiness logs and honors ",(0,i.jsx)(s.code,{children:"PORT"}),"/",(0,i.jsx)(s.code,{children:"NODE_ENV"}),"/",(0,i.jsx)(s.code,{children:"API_BASE_URL"}),"."]}),"\n",(0,i.jsx)(s.li,{children:"Watch mode should debounce restarts (\u2265250\u202fms) to avoid thrashing when esbuild emits multiple files."}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"proposed-architecture",children:"Proposed Architecture"}),"\n",(0,i.jsx)(s.h3,{id:"1-cli--workflow-updates-c",children:"1. CLI & Workflow updates (C#)"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Add ",(0,i.jsx)(s.code,{children:"BackendTestWorkflow"})," and ",(0,i.jsx)(s.code,{children:"BackendDevWorkflow"})," inside ",(0,i.jsx)(s.code,{children:"webstir-dotnet/Engine/Workflows/"}),".","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"BackendTestWorkflow"})," shares the existing ",(0,i.jsx)(s.code,{children:"TestWorkflow"})," steps (build, tsc, provider build) but injects a new ",(0,i.jsx)(s.code,{children:"BackendTestHarness"})," right after ",(0,i.jsx)(s.code,{children:"CompileBackendAsync()"}),"."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"BackendDevWorkflow"})," wraps ",(0,i.jsx)(s.code,{children:"startBackendWatch"})," (spawned via ",(0,i.jsx)(s.code,{children:"node dist/watch.js"}),") using ",(0,i.jsx)(s.code,{children:"ProcessRunner"}),". It listens for the readiness log before marking the Dev Service \u201cready\u201d and can optionally trigger backend tests after each successful build."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["Extend ",(0,i.jsx)(s.code,{children:"webstir-dotnet/CLI/Help.cs"})," + DI wiring so ",(0,i.jsx)(s.code,{children:"webstir backend test"}),"/",(0,i.jsx)(s.code,{children:"dev"})," are discoverable. The legacy ",(0,i.jsx)(s.code,{children:"webstir test"})," command will internally invoke ",(0,i.jsx)(s.code,{children:"BackendTestWorkflow"})," when backend tests exist to keep defaults working."]}),"\n"]}),"\n",(0,i.jsxs)(s.h3,{id:"2-node-side-harness-webstir-iowebstir-backendtesting",children:["2. Node-side harness (",(0,i.jsx)(s.code,{children:"@webstir-io/webstir-backend/testing"}),")"]}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["New export: ",(0,i.jsx)(s.code,{children:"createBackendTestHarness()"})," that starts the compiled backend entry (defaults to ",(0,i.jsx)(s.code,{children:"build/backend/index.js"}),", with Fastify fallback) and returns:","\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-ts",children:"type BackendTestContext = {\n  request: (init?: RequestInit & { path?: string }) => Promise<Response>;\n  manifest: ModuleManifest | null;\n  routes: readonly RouteSpec[];\n  url: URL;\n  env: Record<string, string>;\n};\n"})}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["Provide ",(0,i.jsx)(s.code,{children:"backendTest(name, handler, options?)"})," helper that mirrors ",(0,i.jsx)(s.code,{children:"test()"})," but injects the shared context. Under the hood it calls the existing ",(0,i.jsx)(s.code,{children:"test()"})," API provided by ",(0,i.jsx)(s.code,{children:"@webstir-io/webstir-testing"}),"."]}),"\n",(0,i.jsxs)(s.li,{children:["Respect env contracts:","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"WEBSTIR_BACKEND_TEST_PORT"})," (default 4100; auto-increment if busy)."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"WEBSTIR_BACKEND_TEST_ENTRY"})," to override the server entry (Fastify vs default)."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"WEBSTIR_BACKEND_TEST_ONCE"})," to restart per test file when isolation is required."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.h3,{id:"3-testing-provider-integration-webstir-iowebstir-testing",children:["3. Testing provider integration (",(0,i.jsx)(s.code,{children:"@webstir-io/webstir-testing"}),")"]}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Introduce a backend-aware provider that satisfies the current ",(0,i.jsx)(s.code,{children:"TestProvider"})," interface (",(0,i.jsx)(s.code,{children:"webstir-testing/src/providers.ts"}),"). It wraps the VM runtime but augments the global with ",(0,i.jsx)(s.code,{children:"backendTest"}),"."]}),"\n",(0,i.jsxs)(s.li,{children:["Provider responsibilities:","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Before executing a file, launch the backend harness (if not already running) and share the context via a global symbol."}),"\n",(0,i.jsxs)(s.li,{children:["After the file completes, stop or recycle the server based on ",(0,i.jsx)(s.code,{children:"WEBSTIR_BACKEND_TEST_ONCE"}),"."]}),"\n",(0,i.jsx)(s.li,{children:"Emit module-level log events so the C# runner can show backend-specific failures distinctly."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["Backend tests live under ",(0,i.jsx)(s.code,{children:"src/backend/tests/**/*.test.ts"})," (current default), so no manifest changes are required."]}),"\n"]}),"\n",(0,i.jsx)(s.h3,{id:"4-dev-server-plumbing",children:"4. Dev server plumbing"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"ProcessHandle"})," already exposes ",(0,i.jsx)(s.code,{children:"WaitForReadyAsync()"})," with a readiness token. Update ",(0,i.jsx)(s.code,{children:"NodeServer"})," (used by ",(0,i.jsx)(s.code,{children:"DevService"}),") to watch for the backend readiness message so ",(0,i.jsx)(s.code,{children:"webstir backend dev"})," can block until the server is usable."]}),"\n",(0,i.jsxs)(s.li,{children:["Watch mode flow:","\n",(0,i.jsxs)(s.ol,{children:["\n",(0,i.jsxs)(s.li,{children:["Spawn ",(0,i.jsx)(s.code,{children:"node dist/watch.js"})," from ",(0,i.jsx)(s.code,{children:"@webstir-io/webstir-backend"})," (honoring ",(0,i.jsx)(s.code,{children:"WEBSTIR_BACKEND_TYPECHECK"})," toggles)."]}),"\n",(0,i.jsxs)(s.li,{children:["On rebuild success, restart the runtime server (",(0,i.jsx)(s.code,{children:"node build/backend/index.js"}),") and run backend tests (if ",(0,i.jsx)(s.code,{children:"--tests"})," was passed)."]}),"\n",(0,i.jsxs)(s.li,{children:["Stream diagnostics to the console the same way ",(0,i.jsx)(s.code,{children:"startBackendWatch"})," currently prints esbuild messages."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"validation-strategy",children:"Validation Strategy"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Unit"}),": Add focused tests for ",(0,i.jsx)(s.code,{children:"BackendTestHarness"})," (mock server, verify retries) and CLI argument parsing."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Integration"}),": Extend ",(0,i.jsx)(s.code,{children:"Tester/Workflows/Test/TestWorkflowTests.cs"})," with scenarios that include backend tests hitting a fake route (compile sample project, assert HTTP 200 using the harness)."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Manual"}),": Run ",(0,i.jsx)(s.code,{children:"webstir backend dev --tests"})," inside the sample workspace to verify hot rebuilds restart the server and re-run tests without hanging."]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"rollout--steps",children:"Rollout / Steps"}),"\n",(0,i.jsxs)(s.ol,{children:["\n",(0,i.jsxs)(s.li,{children:["Ship the design doc (this file) and link it from ",(0,i.jsx)(s.code,{children:"PLAN.md"})," / ",(0,i.jsx)(s.code,{children:"TODO.md"}),"."]}),"\n",(0,i.jsxs)(s.li,{children:["Implement Node harness + testing provider updates (",(0,i.jsx)(s.code,{children:"@webstir-io/webstir-backend"})," + ",(0,i.jsx)(s.code,{children:"@webstir-io/webstir-testing"}),")."]}),"\n",(0,i.jsxs)(s.li,{children:["Add new CLI workflows + help text in ",(0,i.jsx)(s.code,{children:"webstir-dotnet"}),"."]}),"\n",(0,i.jsxs)(s.li,{children:["Update docs (",(0,i.jsx)(s.code,{children:"webstir-portal/docs/how-to/test.md"}),", CLI reference) with usage examples."]}),"\n",(0,i.jsxs)(s.li,{children:["Enable backend tests inside ",(0,i.jsx)(s.code,{children:"webstir watch"})," once stability is proven."]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"open-questions",children:"Open Questions"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Should the harness auto-provision database/auth adapters, or do we rely on user-provided test doubles initially?"}),"\n",(0,i.jsx)(s.li,{children:"Do we need per-test isolation (restart server + reset module state) or is file-level isolation sufficient?"}),"\n",(0,i.jsx)(s.li,{children:"How should we surface contract schema mismatches? (Option A: fail tests immediately; Option B: emit warnings and let assertions decide.)"}),"\n",(0,i.jsxs)(s.li,{children:["Where should we persist integration test fixtures (inline in tests vs ",(0,i.jsx)(s.code,{children:"tests/fixtures/*"})," with helper loaders)?"]}),"\n"]})]})}function h(e={}){const{wrapper:s}={...(0,r.R)(),...e.components};return s?(0,i.jsx)(s,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}}}]);